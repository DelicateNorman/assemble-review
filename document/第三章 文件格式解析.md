# 逆向工程分析技术

鲁宏伟

luhw@hust.edu.cn

# 第三章

# 文件格式解析

本章介绍三种文件格式：PE 文件、ELF 文件以及 DEX 文件。

我们面对一个分析对象时，首先需要了解它是个什么文件，不同运行平台下的文件格式会有很大的不同。

- 通过上一章示例的分析，我们知道了在用 IDA Pro 打开一个文件时，它能够帮助我们识别分析对象的文件格式，既如此，为什么还需要了解这些文件格式呢？  
- 程序开发人员为了增加程序逆向分析的难度，在不影响程序正常运行和功能的前提下，会可以对文件进行修改，以对抗常见工具的分析，此时，要想更好地使用常见工具，就必须在理解文件格式或者结构的基础上，对程序文件进行一些“修复”，使其能够适用于常见工具的分析。此外，如果需要自己开发一些分析工具，那就更应该熟悉常见文件的格式了。

# 示例

• 先来看一个 Android App 安装包 ch3_example.apk  
- 这是一个压缩文件

![](https://cdn-mineru.openxlab.org.cn/result/2025-10-27/36cc94d6-4fc3-4935-8781-c4345c50efe0/fdd59bec5b48373d9d89a2a3c57d942680ad8fdbdf11b79046cbf5f03cd0ac92.jpg)

- 我们采用 Android Killer 来反编译 APK 文

![](https://cdn-mineru.openxlab.org.cn/result/2025-10-27/36cc94d6-4fc3-4935-8781-c4345c50efe0/fe28f21ae5ffea407259c429702ea839fc6ab7b32bd4b15c17df985e0ecda756.jpg)

- 指向的是基于 classes.dex 反编译的 smali 代码  
- 一个  $16.3 \mathrm{M}$  的文件为什么反编译生成的代码如此少？  
- 这意味着该文件可能被加密处理了，它使得反编译工具无法直接对其进行反编译

![](https://cdn-mineru.openxlab.org.cn/result/2025-10-27/36cc94d6-4fc3-4935-8781-c4345c50efe0/56061170df327aa24950871ef6b5c6b31b0040218a1c3df1727977c52cb5e21f.jpg)

- 为了还原 classes.dex，需要分析其加密或者解密原理  
- 通过分析, 判断解密过程是在 libshella-2.8.so 中完成的。  
- 这是一个 ELF 文件，尝试采用 IDA Pro 对其进行反汇编分析

![](https://cdn-mineru.openxlab.org.cn/result/2025-10-27/36cc94d6-4fc3-4935-8781-c4345c50efe0/37b8f2b107587a29e16eed45d925c2dd43e63e2ffd7e35c43c8ea34a1caaa808.jpg)

- IDA 打开该 so 文件, 弹出 Warning, 同时在 Exports 窗口看不到任何引出的函数。

![](https://cdn-mineru.openxlab.org.cn/result/2025-10-27/36cc94d6-4fc3-4935-8781-c4345c50efe0/134e63df2f45895947725c9117fc58379616dab11197605f413950a319ce3770.jpg)

![](https://cdn-mineru.openxlab.org.cn/result/2025-10-27/36cc94d6-4fc3-4935-8781-c4345c50efe0/3caf1f66650b8e72f7e014298aca143edbbf7b3e4ba9f070bfd4a13764d47e56.jpg)

![](https://cdn-mineru.openxlab.org.cn/result/2025-10-27/36cc94d6-4fc3-4935-8781-c4345c50efe0/8e5dc692dcfbe5a8f880177b6ee85077c9b49cb56f40bdf86cd05ba2e3c77e61.jpg)

- 如果我们熟悉 ELF 文件格式，根据 Warning 的提示，对文件做适当的修改，重新打开这个文件，提示没有了，而且出现了引出函数

![](https://cdn-mineru.openxlab.org.cn/result/2025-10-27/36cc94d6-4fc3-4935-8781-c4345c50efe0/45a023d04355874b8268e5d98f63499ee6a0568e556d825a4dd89422492f7a7b.jpg)

```asm
EXPORT JNI_OnLoad  
JNI_OnLoad  
; CODE XREF: sub_898+8C↑p  
; DATA XREF: LOAD:0000420C↓o  
SVCLE 0x9E04E5  
STRMIT R0, [R8], LR, LSR#19  
STRVS R2, [R6], LR, ROR#25  
;  
DCD 0xF7D41ADF, 0xF9BE6C01, 0x2260B16A, 0xA0686A25, 0xC4D4DCEF  
DCD 0x82280FE2, 0xDD0507A5, 0xD5710877, 0xE61C0D7, 0x73C37386  
DCD 0xDDAC5D34, 0xA028A6D9, 0x447CF4EB, 0xD9D3A58, 0xD6316A27  
DCD 0x55C52348, 0xDD738249B, 0xCC2CFD36, 0x8D40085D, 0xEF5DF377  
DCD 0x57CCA241, 0x2212219D, 0xDDDECD, 0x23A3AFAE, 0xD47EDEFF
```

# PE 文件格式简介

- PE 文件使用的是一个平面地址空间，所有代码和数据都被合并在一起，组成一个很大的组织结构。  
- 文件的内容分割为不同的区块（Section，又称区段，节等），区段中包含代码数据，各个区块按照页边界来对齐，区块没有限制大小，是一个连续的结构。  
- 每块都有他自己在内存中的属性，比如：这个块是否可读可写，或者只读等等。

认识 PE 文件不是作为单一内存映射文件被装入内存是很重要的，Windows 加载器（PE 加载器）遍历 PE 文件并决定文件的哪个部分被映射，这种映射方式是将文件较高的偏移位置映射到较高的内存地址中。  
- 磁盘文件的数据结构中的内容，几乎能在被装入到内存映射文件中找到相同的信息。但是数据之间的位置可能改变，其某项的偏移地址可能区别于原始的偏移位置。二者的映射关系如图所示。

![](https://cdn-mineru.openxlab.org.cn/result/2025-10-27/36cc94d6-4fc3-4935-8781-c4345c50efe0/2f9ad25b513620fa8f038dd25c36faf363a71142b2b6cd2503ef8b861d784b8e.jpg)

- 几个重要概念，分别是基地址、相对虚拟地址和文件偏移地址。  
- 基地址:  
- 当 PE 文件通过 Windows 加载器被装入内存后，内存中的版本被称作模块。映射文件的起始地址被称作模块句柄，可以通过模块句柄访问其他的数据结构。  
- 这个初始内存地址就是基地址。

- 几个重要概念，分别是基地址、相对虚拟地址和文件偏移地址。  
- 相对虚拟地址:  
- 在可执行文件中，有相当多的地方需要指定内存的地址。为了在 PE 文件中避免有确定的内存地址，出现了相对虚拟地址 (Relative Virtual Address, 简称 RVA) 的概念。  
- RVA 只是内存中的一个简单的相对于 PE 文件装入地址的偏移地址，它是一个“相对”地址，或者称位“偏移量”地址。

- 几个重要概念，分别是基地址、相对虚拟地址和文件偏移地址。  
文件偏移地址:  
- 当 PE 文件存储在磁盘上时，某个数据的位置相对于文件头的偏移量也称文件偏移地址（File Offset）或者物理地址（RAW Offset）。  
- 文件偏移地址从 PE 文件的第一个字节开始计数，起始为零。

# 头部信息

- PE 文件的结构如图所示：从起始位置开始依次是 DOS 头、PE 文件头、节表以及具体的节。

文件物理基址（用于文件偏移量）

由映像基址偏移0x3C

DOS头

未使用

OEM标识符/信息

至PE头的偏移

DOS Stub 程序&重定位表

未使用

PE头（8字节）

区段头

映像页：

导入信息

导出信息

资源信息

基址重定位信息

其他信息

# 头部信息

- PE 文件的结构如图所示：从起始位置开始依次是 DOS 头、PE 文件头、节表以及具体的节。

<table><tr><td colspan="19">Experient-1.exe ×</td></tr><tr><td>00000000</td><td>4D</td><td>5A</td><td>9B</td><td>0B</td><td>03</td><td>0B</td><td>0B</td><td>0B</td><td>04</td><td>0B</td><td>0B</td><td>0B</td><td>FF</td><td>FF</td><td>0B</td><td>0B</td><td>MZ</td><td></td></tr><tr><td>00000010</td><td>B8</td><td>0B</td><td>0B</td><td>1</td><td colspan="4">PE文件分开始地址</td><td>4B</td><td>0B</td><td>0B</td><td>0B</td><td>0B</td><td>0B</td><td>0B</td><td>0B</td><td>. . . . . . .</td><td></td></tr><tr><td>00000020</td><td>0B</td><td>0B</td><td>0B</td><td>0B</td><td>0B</td><td>0B</td><td>0B</td><td>0B</td><td>0B</td><td>0B</td><td>0B</td><td>0B</td><td>0B</td><td>0B</td><td>0B</td><td>0B</td><td>. . . . . . .</td><td></td></tr><tr><td>00000030</td><td>0B</td><td>0B</td><td>0B</td><td>0B</td><td>0B</td><td>0B</td><td>0B</td><td>0B</td><td>0B</td><td>0B</td><td>0B</td><td>0B</td><td>F8</td><td>0B</td><td>0B</td><td>0B</td><td>. . . . . . .</td><td></td></tr><tr><td>00000040</td><td>0E</td><td>1F</td><td>BA</td><td>0E</td><td>0B</td><td>B4</td><td>09</td><td>CD</td><td>21</td><td>B8</td><td>01</td><td>42</td><td>CD</td><td>24</td><td>54</td><td>69</td><td>偏移)地址:..L..!Th</td><td></td></tr><tr><td>00000050</td><td>69</td><td>73</td><td>2B</td><td>7B</td><td>72</td><td>6F</td><td>67</td><td>72</td><td>61</td><td>6D</td><td>2B</td><td>63</td><td>61</td><td>6E</td><td>6E</td><td>6F</td><td>is program canno</td><td></td></tr><tr><td>00000060</td><td>74</td><td>2B</td><td>62</td><td>65</td><td>2B</td><td>72</td><td>75</td><td>6E</td><td>2B</td><td>69</td><td>6E</td><td>2B</td><td>44</td><td>4F</td><td>53</td><td>2B</td><td>t be run in DOS</td><td></td></tr><tr><td>00000070</td><td>6D</td><td>6F</td><td>64</td><td>65</td><td>2E</td><td>0D</td><td>0D</td><td>0A</td><td>24</td><td>0B</td><td>0B</td><td>0B</td><td>0B</td><td>0B</td><td>0B</td><td>0B</td><td>mode....$......</td><td></td></tr><tr><td>00000080</td><td>63</td><td>2B</td><td>23</td><td>F5</td><td>27</td><td>49</td><td>4D</td><td>A6</td><td>27</td><td>49</td><td>4D</td><td>A6</td><td>27</td><td>49</td><td>4D</td><td>A6</td><td>c(#.&#x27;IM.&#x27;IM.&#x27;IM.</td><td></td></tr><tr><td>00000090</td><td>48</td><td>2D</td><td>4E</td><td>A7</td><td>36</td><td>49</td><td>4D</td><td>A6</td><td>48</td><td>2D</td><td>4B</td><td>A7</td><td>95</td><td>49</td><td>4D</td><td>A6</td><td>H-N.6IM.H-H..IM.</td><td></td></tr><tr><td>000000a0</td><td>48</td><td>2D</td><td>49</td><td>A7</td><td>31</td><td>49</td><td>4D</td><td>A6</td><td>75</td><td>21</td><td>4E</td><td>A7</td><td>33</td><td>49</td><td>4D</td><td>A6</td><td>H-I.1IM.u!N.3IM.</td><td></td></tr><tr><td>000000b0</td><td>75</td><td>21</td><td>48</td><td>A7</td><td>63</td><td>49</td><td>4D</td><td>A6</td><td>75</td><td>21</td><td>49</td><td>A7</td><td>06</td><td>49</td><td>4D</td><td>A6</td><td>u!H.cIM.u!I..IM.</td><td></td></tr><tr><td>000000c0</td><td>48</td><td>2D</td><td>4C</td><td>A7</td><td>24</td><td>49</td><td>4D</td><td>A6</td><td>27</td><td>49</td><td>4C</td><td>A6</td><td>7F</td><td>49</td><td>4D</td><td>A6</td><td>H-L.$IM.&quot;IL..IM.</td><td></td></tr><tr><td>000000d0</td><td>4B</td><td>21</td><td>48</td><td>A7</td><td>25</td><td>49</td><td>4D</td><td>A6</td><td>4B</td><td>21</td><td>B2</td><td>A6</td><td>26</td><td>49</td><td>4D</td><td>A6</td><td>K!H.%IM.K!..&amp;IM.</td><td></td></tr><tr><td>000000e0</td><td>4B</td><td>21</td><td>4F</td><td>A7</td><td>26</td><td>49</td><td>4D</td><td>A6</td><td>52</td><td>69</td><td>63</td><td>68</td><td>27</td><td>49</td><td>4D</td><td>A6</td><td>K!O.&amp;IM.Rich&#x27;IM.</td><td></td></tr><tr><td>000000f0</td><td>0B</td><td>0B</td><td>0B</td><td>0B</td><td>0B</td><td>0B</td><td>0B</td><td>0B</td><td>5B</td><td>45</td><td>0B</td><td>0B</td><td>4C</td><td>01</td><td>09</td><td>0B</td><td>. . . . . PE..L...</td><td></td></tr></table>

# 头部信息

```diff
0:000> dt /r1 ntdll!_IMAGE_NT Headers notepad+e0  
+0x000 Signature : 0x4550  
+0x004 FileHeader : _IMAGE_FILEHEADER  
+0x000 Machine : 0x14c  
+0x002 NumberOfSections : 3  
+0x004 TimeDateStamp : 0x48025287  
+0x008 PointerToSymbolTable : 0  
+0x00c NumberOfSymbols : 0  
+0x010 SizeOfOptionalHeader : 0xe0  
+0x012 Characteristics : 0x10f  
+0x018 OptionalHeader : _IMAGE_OPTIONALHEADER  
+0x000 Magic : 0x10b  
+0x002 MajorLinkerVersion : 0x7  
+0x003 MinorLinkerVersion : 0xa  
+0x004 SizeOfCode : 0x7800  
+0x008 SizeOf InitializedData : 0x8800  
+0x00c SizeOfUninitializedData : 0  
+0x010 AddressOfEntryPoint : 0x739d  
+0x014 BaseOfCode : 0x1000  
+0x018 BaseOfData : 0x9000  
+0x01c ImageBase : 0x1000000  
+0x020 SectionAlignment : 0x1000  
+0x024 FileAlignment : 0x200  
+0x028 MajorOperatingSystemVersion : 5  
+0x02a MinorOperatingSystemVersion : 1  
+0x02c MajorImageVersion : 5  
+0x02e MinorImageVersion : 1  
+0x030 MajorSubsystemVersion : 4  
+0x032 MinorSubsystemVersion : 0  
+0x034 Win32VersionValue : 0  
+0x038 SizeOfImage : 0x13000  
+0x03c SizeOfHeaders : 0x400  
+0x040 CheckSum : 0x18ada  
+0x044 Subsystem : 2  
+0x046 DllCharacteristics : 0x8000  
+0x048 SizeOfStackReserve : 0x40000  
+0x04c SizeOfStackCommit : 0x1100  
+0x050 SizeOfHeapReserve : 0x10000  
+0x054 SizeOfHeapCommit : 0x1000  
+0x058 LoaderFlags : 0  
+0x05c NumberOfRvaAndSizes : 0x10  
+0x06O DataDirectory : [16] _IMAGE_DATA_DIR
```

Signature：类似于DOS头中的e_magic，其高16位是0，低16是0x4550，用字符表示是'PE'。

IMAGE_FILEHEADER是PE文件头，c语言的定义是这样的：

# [cpp]

1. typedef struct _IMAGE_FILEHEADER {  
2. WORD Machine;  
3. WORD NumberOfSections;  
4. DWORD TimeDateStamp;  
5. DWORD PointerToSymbolTable;  
6. DWORD NumberOfSymbols;  
7. WORD SizeOfOptionalHeader;  
8. WORD Characteristics;  
9.} IMAGE_FILEHEADER, *PIMAGE_FILEHEADER;

可以看出，PE 文件头定义了 PE 文件的一些基本信息和属性，这些属性会在 PE 加载器加载时用到，如果加载器发现 PE 文件头中定义的一些属性不满足当前的运行环境，将会终止加载该 PE。

# 各种块的描述

- PE 文件一般至少都会有两个区块：一个是代码块，另一个是数据块。每一个区块都需要有一个截然不同的名字，这个名字主要是用来表达区块的用途。  
- 区块在映像中是按起始地址（RVA）来排列的，而不是按字母表顺序。  
- 使用区块名字只是人们为了认识和编程的方便，而对操作系统来说这些是无关紧要的。微软给这些区块取了个有特色的名字，但这不是必须的。  
- 在从 PE 文件中读取需要的内容时，如输入表、输出表，不能以区块名字作为参考，正确的方法是按照数据目录表中的字段来进行定位。

# 各种块的描述

<table><tr><td>名称</td><td>描述</td></tr><tr><td>.text</td><td>默认的代码区块,它的内容全是指令代码,链接器把所有目标文件的text块连接成一个大的.text块,使用Borland C++,编译器产生的代码存放在CODE的区域里</td></tr><tr><td>.data</td><td>默认的读/写数据块,全局变量,静态变量一般放在这个区段</td></tr><tr><td>.rdata</td><td>默认只读数据区块,但程序中很少用到该块中的数据,一般两种情况用到,一是MS的链接器产生EXE文件中用于存放调试目录,二是用于存放说明字符串,如果程序的DEF文件中指定了DESCRIPTION,字符串就会出现在rdata中</td></tr><tr><td>.idata</td><td>包含其他外来的DLL的函数及数据信息,即输入表,将.idata区块合并成另一个区块已成为一种惯例,典型的是.rdata区块,默认的,链接器只在创建一个Release模式的可执行文件时才能将idata合并到另外一个区块中</td></tr><tr><td>.edata</td><td>输出表,当创建一个输出API或数据的可执行文件时,连接器会创建一个.EXP文件,这个.EXP文件包含一个.edata区块,其会被加载到可执行文件中,经常被合并到.text或.rdata 区块中</td></tr><tr><td>.rsrc</td><td>资源,包括模块的全部资源,如图标,菜单,位图等,这个区块是只读的,无论如何不应该把它命名为.rsrc以外的名字,也不能合并到其他的区块里</td></tr><tr><td>.bss</td><td>未初始化的数据,很少在用,取而代之的是执行文件的.data区块的的VirtualSize被扩展大的空间里用来装未初始化的数据.</td></tr><tr><td>.crt</td><td>用于C++ 运行时(CRT)所添加的数据</td></tr><tr><td>.tls</td><td>TLS的意思是线程局部存储器,用于支持通过declspec thread)声明的线程局部存储变量的数据,这包括数据的初始化值,也包括运行时所需要的额外变量</td></tr><tr><td>.reloc</td><td>可执行文件的机制重定位,基址重定位一般仅D11需要的</td></tr><tr><td>.sdata</td><td>相对于全局指针的可被定位的 矩的读写数据</td></tr><tr><td>.pdata</td><td>异常表,包含CPU特定的IAMGE_RUNNING_TIMEFUNTION_ENTRY结构数组,,DataDirectory中的IMAGE_DIRECTORY_ENTRYexception指向它.</td></tr><tr><td>.didat</td><td>延迟装入输入数据,在非Release模式下可以找到</td></tr></table>

![](https://cdn-mineru.openxlab.org.cn/result/2025-10-27/36cc94d6-4fc3-4935-8781-c4345c50efe0/361ad1f3d07d35c57afe1f52b77164cfb96372a1cbe01a3b693e8db1407cc19e.jpg)

,

# 各种块的描述

<table><tr><td>000001f0</td><td>2E</td><td>74</td><td>65</td><td>78</td><td>74</td><td>62</td><td>73</td><td>73</td><td>D9</td><td>89</td><td>08</td><td>00</td><td>00</td><td>10</td><td>00</td><td>00</td><td>. textbss</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>00000200</td><td>00</td><td>00</td><td>00</td><td>00</td><td>00</td><td>00</td><td>00</td><td>00</td><td>00</td><td>00</td><td>00</td><td>00</td><td>00</td><td>00</td><td>00</td><td>00</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>00000210</td><td>00</td><td>00</td><td>00</td><td>00</td><td>A0</td><td>00</td><td>00</td><td>E0</td><td>2E</td><td>74</td><td>65</td><td>78</td><td>74</td><td>00</td><td>00</td><td>00</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>00000220</td><td>11</td><td>6E</td><td>12</td><td>00</td><td>00</td><td>A0</td><td>00</td><td>00</td><td>00</td><td>70</td><td>12</td><td>00</td><td>00</td><td>04</td><td>00</td><td>00</td><td>. n. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
00000230</td><td>00</td><td>00</td><td>00</td><td>00</td><td>00</td><td>00</td><td>00</td><td>00</td><td>00</td><td>00</td><td>00</td><td>00</td><td>20</td><td>00</td><td>00</td><td>60</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>00000240</td><td>2E</td><td>72</td><td>64</td><td>61</td><td>74</td><td>61</td><td>00</td><td>00</td><td>C0</td><td>F5</td><td>03</td><td>00</td><td>00</td><td>10</td><td>1B</td><td>00</td><td>rdata. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 
00000250</td><td>00</td><td>F6</td><td>03</td><td>00</td><td>00</td><td>74</td><td>12</td><td>00</td><td>00</td><td>00</td><td>00</td><td>00</td><td>00</td><td>00</td><td>00</td><td>00</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>00000260</td><td>00</td><td>00</td><td>00</td><td>00</td><td>40</td><td>00</td><td>00</td><td>40</td><td>2E</td><td>64</td><td>61</td><td>74</td><td>61</td><td>00</td><td>00</td><td>00</td><td></td><td>. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
80</td><td>00</td><td>3D</td><td>00</td><td>00</td><td>00</td><td>10</td><td>1F</td><td>00</td><td>00</td><td>22</td><td>00</td><td>00</td><td>00</td><td>6A</td><td>16</td><td>00</td><td>= . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 
80</td><td>00</td><td>80</td><td>00</td><td>00</td><td>00</td><td>80</td><td>00</td><td>00</td><td>00</td><td>80</td><td>00</td><td>00</td><td>80</td><td>00</td><td>00</td><td>. 
80</td><td>80</td><td>00</td><td>00</td><td>80</td><td>00</td><td>80</td><td>00</td><td>80</td><td>00</td><td>80</td><td>00</td><td>80</td><td>. 
80</td><td>80</td><td>00</td><td>00</td><td>80</td><td>00</td><td>80</td><td>00</td><td>80</td><td>80</td><td>00</td><td>80</td><td>. 
80</td><td>80</td><td>00</td><td>00</td><td>80</td><td>00</td><td>80</td><td>80</td><td>. 
80</td><td>80</td><td>. 
80</td><td>. 
80</td><td>. 
80</td><td>. 
80</td><td>. 
80</td><td>. 
80</td><td>. 
80</td><td>. 
80</td><td>. 
80</td><td>. 
80</td><td>. 
80</td><td>. 
80</td><td>. 
80</td><td>. 
80</td><td>. 
80</td><td>. 
80</td><td>. 
80</td><td>. 
80</td><td>. 
80</td><td>. 
80</td><td>. 80</td><td>. 
80</td><td>. 
80</td><td>. 
80</td><td>. 
80</td><td>. 
80</td><td>. 
80</td><td>. 
80</td><td>. 
80</td><td>. 
80</td><td>. 
80</td><td>. 
80</td><td>. 
80</td><td>. 
80</td><td>. 
80</td><td>. 
80</td><td>. 
80</td><td>. 
80</td><td>. 
80</td><td>. 
80</td><td>.</td><td>. 
. 
. 
. 
. 
. 
. 
. 
. 
. 
. 
. 
. 
. 
. 
. 
. 
. 
. 
. 
. 
. 
. 
. 
. 
. 
. 
. 
. 
. 
. 
. 
. 
. 
. 
. 
. 
. 
. 
. 
. 
. 
. 
. 
. 
. 
. 
. 
. 
. 
. 80</td><td>39</td><td>01</td><td>00</td><td>00</td><td>60</td><td>1F</td><td>00</td><td>00</td><td>02</td><td>00</td><td>00</td><td>00</td><td>98</td><td>16</td><td>00</td><td>9</td><td></td></tr></table>

# 导入表和导出表

- PE 文件运行过程中并不是独立运行的，它必须要借助 Windows 系统的系统函数才能完成其功能。常见的如 USER32，KERNEL32 等 DLL。导入表所起的作用就是帮助载入的 PE 找到所需调用的函数。  
- 在 PE 文件中, 有个专门的数组用来处理每个被导入的 DLL 程序的信息。每个这样的结构都给出了被导入 DLL 的名称并且指向一组函数指针, 这组函数指针就是导入地址表 (Import Address Table, 简称 ITA)。

![](https://cdn-mineru.openxlab.org.cn/result/2025-10-27/36cc94d6-4fc3-4935-8781-c4345c50efe0/810b9a12ddb58e569c253febd95be42e8256ab5eaca68b4bf2ccba77d76283c7.jpg)

# ELF 文件格式简介

- ELF 的英文全称是 The Executable and Linking Format，最初是由 UNIX 系统实验室开发、发布的 ABI(Application Binary Interface) 接口的一部分，也是 Linux 的主要可执行文件格式。

- 从使用上来说，主要的 ELF 文件的种类主要有三类：  
- 可执行文件 (.out)：Executable File，包含代码和数据，是可以直接运行的程序。其代码和数据都有固定的地址（或相对于基地址的偏移），系统可根据这些地址信息把程序加载到内存执行。  
- 可重定位文件 (.o 文件): Relocatable File, 包含基础代码和数据, 但它的代码及数据都没有指定绝对地址, 因此它适合于与其他目标文件链接来创建可执行文件或者共享目标文件。  
• 共享目标文件 (.so) : Shared Object File, 也称动态库文件, 包含了代码和数据, 这些数据是在链接时被链接器 (Id) 和运行时动态链接器 (Id.so.1、libc.so.1、ld-linux.so.1) 使用的。

# ELF 文件基本格式

- ELF 文件由 4 部分组成，分别是 ELF 头（ELF header）、程序头表（Program header table）、节（Section）和节头表（Section header table）。  
- 实际上，一个文件中不一定包含全部内容，而且他们的位置也未必如同所示这样安排，只有 ELF 头的位置是固定的，其余各部分的位置、大小等信息由 ELF 头中的各项值来决定。

ELF header

Program header table

.text

.rodata

.data

Section header table

# ELF 文件基本格式

- ELF 文件格式提供了两种视图，分别是链接视图和执行视图。  
- 链接视图是以节（section）为单位，执行视图是以段（segment）为单位。  
- 链接视图就是在链接时用到的视图，而执行视图则是在执行时用到的视图。从程序执行视角来说，这就是Linux加载器加载的各种Segment的集合。比如只读代码段、数据的读写段、符号段等等

ELF header

Program header table

.text

.rodata

.data

Section header table

# ELF 文件基本格式

- Program Header Table 描述文件中的各种 segments，用来告诉系统如何创建进程映像的  
- segments 是从运行的角度来描述 ELF 文件，sections 是从链接的角度来描述 ELF 文件，也就是说，在链接阶段，可以忽略 Program Header Table，在运行阶段可以忽略 Section Header Table。  
• 从图中我们也可以看出，segments与sections是包含的关系，一个segment包含若干个section

![](https://cdn-mineru.openxlab.org.cn/result/2025-10-27/36cc94d6-4fc3-4935-8781-c4345c50efe0/0a3b0adba0efa6ac80dd40ded671198725c7cfb46c8ed6ef67e4d940d9422720.jpg)

# DEX文件简介

- Android 系统是以 Linux 为内核构建的。Android 应用使用 Java 开发,运行在虚拟机之上。Java 文件并不能直接在 Java 虚拟机上运行, 需要将其转换成 class 文件。通常一个基于 Java 语言开发的应用程序会包含很多 class 文件, 需要将这些 class 文件打包成一个 jar 文件, 然后在 Java 虚拟机上运行这个 jar 文件。  
- Google 为了降低应用的开发难度，并将其适配到不同硬件配置的设备上，在 Linux 内核之上构建了一个虚拟机。Dalvik 就是 Android4.4 及之前使用的虚拟机（简称 DVM），它使用的是 JIT（Just-In-Time）技术来进行代码转译，每次执行应用的时候，Dalvik 将程序的代码编译为机器语言执行。

- 当java 程序编译成class后，还需要使用dx工具将所有的class文件整合到一个dex文件（而不是一般Java虚拟机中的jar文件），目的是其中各个类能够共享数据，在一定程度上降低了冗余，同时也是文件结构更加紧凑，实验表明，dex文件是传统jar文件大小的  $50\%$  左右。  
- Dex（Dalvik Executable format），即 Dalvik 可执行文件格式。

- dex 文件和 class 文件区别主要体现在以下几个方面：

$\checkmark$  class 文件存在很多的冗余信息，dex 工具会去除冗余信息，并把所有的 .class 文件整合到 .dex 文件中。减少了 I/O 操作，提高了类的查找速度，让 dex 文件执行的更快，更节省内存。  
✓ dex 文件运行的虚拟机 DVM 的字节码指令是 16 位, 而通常 class 文件运行的虚拟机 JVM 是 8 位。  
√ DVM是基于寄存器的虚拟机，而JVM执行是基于虚拟栈的虚拟机。寄存器存取速度比栈快的多，DVM可以根据硬件实现最大的优化，比较适合移动设备。

- 分析 DEX 文件格式的目的是因为 dex 里面包含了重要的 APP 代码，利用反编译工具可以获取 java 源码。  
- 理解并修改 dex 文件，就能更好的对apk进行破解或者防破解（比如，对dex文件进行加密

# DEX 文件结构

- dex 的文件是由 9 个不同结构的数据体以首尾相接的方式拼接而成。

<table><tr><td></td><td>数据名称</td><td>解释</td></tr><tr><td>文件头</td><td>header</td><td>dex 文件头部，记录整个 dex 文件的相关属性</td></tr><tr><td rowspan="6">索引区</td><td>string_ids</td><td>字符串数据索引，记录了每个字符串在数据区的偏移量</td></tr><tr><td>type_ids</td><td>类型数据索引，记录了每个类型的字符串索引</td></tr><tr><td>proto_ids</td><td>原型数据索引，记录了方法声明的字符串，返回类型字符串，参数列表</td></tr><tr><td>field_ids</td><td>字段数据索引，记录了所属类，类型以及方法名</td></tr><tr><td>method_ids</td><td>类方法索引，记录方法所属类名，方法声明以及方法名等信息</td></tr><tr><td>class_defs</td><td>类定义数据索引，记录指定类各类信息，包括接口、超类、类数据偏移量</td></tr><tr><td rowspan="2">数据区</td><td>data</td><td>数据区，保存了各个类的真实数据</td></tr><tr><td>link_data</td><td>链接数据区</td></tr></table>

# DEX 文件结构

header字段的结构  

<table><tr><td>字段名称</td><td>偏移值</td><td>长度</td><td>说明</td><td>示例数据</td></tr><tr><td>magic</td><td>0x0</td><td>8</td><td>魔数字段,值为dex&#x27;n035&#x27;0</td><td>64 65 78 0A 30 35 33 35 00</td></tr><tr><td>checksum</td><td>0x8</td><td>4</td><td>校验码</td><td>32 AC 3C D0</td></tr><tr><td>signature</td><td>0xc</td><td>20</td><td>sha-1 签名</td><td>32 63 99 F3……</td></tr><tr><td>file_size</td><td>0x20</td><td>4</td><td>dex文件总长度</td><td>157Ch</td></tr><tr><td>header_size</td><td>0x24</td><td>4</td><td>文件头长度,009 版本=0x5c,035 版本=0x70</td><td>70h</td></tr><tr><td>endian_tag</td><td>0x28</td><td>4</td><td>标示字节顺序的常量</td><td>12345678h</td></tr><tr><td>link_size</td><td>0x2c</td><td>4</td><td>链接段的大小,如果为0就是静态链接</td><td>0</td></tr><tr><td>link_off</td><td>0x30</td><td>4</td><td>链接段的开始位置</td><td>0</td></tr><tr><td>map_off</td><td>0x34</td><td>4</td><td>map 数据基址</td><td>14ACh</td></tr><tr><td>string_ids_size</td><td>0x38</td><td>4</td><td>字符串列表中字符串个数</td><td>77h</td></tr><tr><td>string_ids_off</td><td>0x3c</td><td>4</td><td>字符串列表基址</td><td>70h</td></tr><tr><td>type_ids_size</td><td>0x40</td><td>4</td><td>类列表里的类型个数</td><td>24h</td></tr><tr><td>type_ids_off</td><td>0x44</td><td>4</td><td>类列表基址</td><td>024Ch</td></tr><tr><td>proto_ids_size</td><td>0x48</td><td>4</td><td>原型列表里面的原型个数</td><td>12h</td></tr></table>

<table><tr><td>proto_ids_off</td><td>0x4c</td><td>4</td><td>原型列表基址</td><td>02DCh</td></tr><tr><td>field_ids_size</td><td>0x50</td><td>4</td><td>字段个数</td><td>1Fh</td></tr><tr><td>field_ids_off</td><td>0x54</td><td>4</td><td>字段列表基址</td><td>03B4h</td></tr><tr><td>method_ids_size</td><td>0x58</td><td>4</td><td>方法个数</td><td>24h</td></tr><tr><td>method_ids_off</td><td>0x5c</td><td>4</td><td>方法列表基址</td><td>04ACh</td></tr><tr><td>class_defs_size</td><td>0x60</td><td>4</td><td>类定义标中类的个数</td><td>0Ch</td></tr><tr><td>class_defs_off</td><td>0x64</td><td>4</td><td>类定义列表基址</td><td>05CCh</td></tr><tr><td>data_size</td><td>0x68</td><td>4</td><td>数据段的大小，必须 4k 对齐</td><td>0E30h</td></tr><tr><td>data_off</td><td>0x6c</td><td>4</td><td>数据段基址</td><td>074Ch</td></tr></table>